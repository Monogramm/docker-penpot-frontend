FROM monogramm/docker-uxbox-builder:latest

ARG UXBOX_THEME=light

ENV LEIN_ROOT=TRUE \
    UXBOX_VERSION=%%VERSION%% \
    UXBOX_CONFIG_URL="/api" \
    UXBOX_DEMO=false \
    UXBOX_DEBUG=false

# Download source from github
ADD https://github.com/uxbox/uxbox/archive/${UXBOX_VERSION}.tar.gz /tmp/uxbox.tar.gz
# or copy frontend from source and build release
#COPY . /home/uxbox/uxbox-${UXBOX_VERSION}/frontend

RUN set -ex; \
    mkdir -p /home/uxbox; \
    cd /home/uxbox; \
    tar -xzf /tmp/uxbox.tar.gz; \
    rm -f /tmp/uxbox.tar.gz; \
    cd /home/uxbox/uxbox-${UXBOX_VERSION}/frontend; \
    rm -f Dockerfile; \
    rm -rf ./dist ./node_modules; \
    sed -i \
        -e 's|"uxbox.config.url" ".*"|"uxbox.config.url" "${UXBOX_CONFIG_URL}"|g' \
        scripts/figwheel.clj; \
    sed -i \
        -e 's|url ".*")|url "${UXBOX_CONFIG_URL}")|g' \
        src/uxbox/config.cljs; \
    sed -i \
        -e "s|'common/dependencies/uxbox-light'|'common/dependencies/uxbox-${UXBOX_THEME}'|g" \
        resources/styles/main.scss; \
    sed -i \
        -e "s|'common/dependencies/uxbox-light'|'common/dependencies/uxbox-${UXBOX_THEME}'|g" \
        resources/styles/view.scss; \
    npm install; \
    npm run prod; \
    bash -c "/home/uxbox/frontend/scripts/dist-main"; \
    bash -c "/home/uxbox/frontend/scripts/dist-view"; \
    bash -c "/home/uxbox/frontend/scripts/dist-worker"



# Once application has been built, prepare production image
FROM nginx:%%VARIANT%%

LABEL maintainer="Monogramm Maintainers <opensource at monogramm dot io>"

ENV LANG=en_US.UTF-8 \
    LC_ALL=C.UTF-8

# Copy built app to www root
COPY --from=0 /home/uxbox/frontend/dist /usr/share/nginx/html

# NGINX configurations
COPY ./nginx/conf.d /etc/nginx/conf.d
